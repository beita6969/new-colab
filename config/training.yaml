# AFlow + ROLL é›†æˆè®­ç»ƒé…ç½®
# ğŸ”¥ K=4, B=6, T=0.1 P0ä¿®å¤é…ç½®
# ä¿®æ”¹æ—¶é—´: 2024-11-25
# é…ç½®ç†å¿µ: K=4æå‡ç¨³å®šæ€§ï¼ŒT=0.1æœ€ä¼˜æ¸©åº¦(å®éªŒè¯æ˜)ï¼Œæ€»batch=48ä¸å˜

# å®éªŒé…ç½®
exp_name: "aflow_grpo_k4_b6_temp01_p0fix"  # K=4 + T=0.1 + P0ä¿®å¤
output_dir: "checkpoints"
log_dir: "logs"
max_steps: 500
save_every: 50
eval_every: 999999
val_samples: 87
log_every: 5

# =====================================
# GRPOç®—æ³•é…ç½®ï¼ˆåŸºäºæ™ºèƒ½ä½“åˆ†æä¼˜åŒ–ï¼‰
# =====================================
adv_estimator: "grpo"
num_return_sequences_in_group: 4   # K=4ï¼ˆç¨³å®šæ€§éªŒè¯ï¼‰
ppo_epochs: 1
async_generation_ratio: 0
use_kl_loss: true
kl_loss_coef: 0.005                # ğŸ”¥ P1ä¿®å¤: ä»0.011é™åˆ°0.005ï¼Œå‡å°‘KLæƒ©ç½šå…è®¸æ›´å¤šæ¢ç´¢
clip_range: 0.20
gamma: 1.0
lambda_gae: 0.95

# =====================================
# Batché…ç½®
# =====================================
rollout_batch_size: 6              # ğŸ”¥ P0ä¿®å¤: B=6ï¼ˆä»8é™ä½ï¼Œä¿æŒæ€»batch=48ï¼‰
prompt_max_length: 3072
response_max_length: 5120

# æ¨¡å‹é…ç½®
base_model: "/home/yijia/verl-agent/models/qwen/Qwen2___5-7B-Instruct"
model_dtype: "bfloat16"

# =====================================
# LoRAé…ç½®
# =====================================
use_lora: true
lora_rank: 64
lora_alpha: 64
lora_target_modules: "q_proj,k_proj,v_proj,o_proj"
lora_dropout: 0.05

# =====================================
# è®­ç»ƒå‚æ•°ï¼ˆåŸºäºæ™ºèƒ½ä½“åˆ†æä¼˜åŒ–ï¼‰
# =====================================
learning_rate: 2.0e-5              # ğŸ”¥ P1ä¿®å¤: æé«˜4å€å¢å¼ºå­¦ä¹ ä¿¡å·(åŸ5e-6å¤ªä½å¯¼è‡´KL=1e-8)
weight_decay: 0.01
max_grad_norm: 1.0                 # ğŸ”¥ P1ä¿®å¤: ä»0.5æå‡åˆ°1.0ï¼Œå…è®¸æ›´å¤§æ¢¯åº¦
gradient_accumulation_steps: 2     # æœ‰æ•ˆbatch=48æ ·æœ¬
warmup_steps: 100                  # ğŸ”¥ P1ä¿®å¤: ä»50å¢åŠ åˆ°100ï¼ˆ20%è®­ç»ƒæ­¥æ•°ï¼‰
bf16: true
gradient_checkpointing: false

# GPUé…ç½®
device_mapping: [0]
physical_gpus: [4]
protected_pids: []
num_gpus: 1
world_size: 1

# æ•°æ®é›†é…ç½®
data_dir: "data"
train_dataset: "11/integrated_aflow_roll/data/ready_to_train/train_final_clean.jsonl"
val_dataset: "11/integrated_aflow_roll/data/ready_to_train/test.jsonl"
test_dataset: "11/integrated_aflow_roll/data/ready_to_train/test.jsonl"

# æ··åˆé‡‡æ ·æ¯”ä¾‹ (2:2:2 å‡åŒ€åˆ†å¸ƒ)
domain_ratios:
  math: 0.333
  code: 0.333
  qa: 0.334

# AFlowé…ç½®
aflow_config_path: "config/aflow_llm.yaml"
aflow_executor_model: "gpt-oss-120b"
aflow_operators: ["Custom", "AnswerGenerate", "Programmer", "ScEnsemble", "Test", "Review", "Revise"]
aflow_operator_descriptions_path: "/home/yijia/.claude/11/AFlow/workspace/MATH/workflows/template/operator.json"
execution_timeout: 600

# =====================================
# å¥–åŠ±é…ç½®ï¼ˆä¿æŒåŸå€¼ï¼‰
# =====================================
reward_weights:
  correctness: 0.65
  efficiency: 0.15
  simplicity: 0.10
  format: 0.05
  repetition: 0.05

# æç¤ºè¯ä¼˜åŒ–ç³»ç»Ÿ
experience_buffer:
  enabled: true
  buffer_size: 100
  reward_threshold: 8.0
  persistence_dir: "data/experience_buffer"

prompt_optimizer:
  enabled: true
  few_shot_k: 3
  similarity_threshold: 0.7

operator_prompt_enhancer:
  enabled: true
  top_k_examples: 2

# ç›‘æ§é…ç½®
wandb:
  enabled: true
  project: "agent-prompt"
  entity: "yao110002-sdfsdfsdfsdf-com"
  api_key: "b42ca0000cf06f97b05eba34f58823ad5f3122a4"
  run_name: null

# =====================================
# Temperatureè°ƒåº¦ï¼ˆå¯ç”¨åŠ¨æ€æ¢ç´¢ï¼‰
# =====================================
temperature_schedule:
  enabled: true                    # ğŸ”¥ P1ä¿®å¤: å¯ç”¨æ¸©åº¦è°ƒåº¦
  initial: 0.5                     # ğŸ”¥ æ—©æœŸé«˜æ¸©å¢åŠ æ¢ç´¢
  final: 0.15                      # ğŸ”¥ åæœŸä½æ¸©åˆ©ç”¨æœ€ä¼˜ç­–ç•¥
  warmup_steps: 150                # ğŸ”¥ 30%æ­¥æ•°å†…å®Œæˆè¡°å‡

# =====================================
# ç”Ÿæˆé…ç½®
# =====================================
generation_config:
  temperature: 0.5                 # ğŸ”¥ åˆå§‹æ¸©åº¦ï¼ˆä¼šè¢«è°ƒåº¦è¦†ç›–ï¼‰
  top_p: 0.95
  top_k: 50
  max_new_tokens: 4096
  do_sample: true

# è°ƒè¯•é€‰é¡¹
debug: false
verbose: true

# =====================================
# WA-GRPOé…ç½®ï¼ˆWorkflow-Awareä¼˜åŠ¿è®¡ç®—ï¼‰
# =====================================
wa_grpo:
  alpha: 0.12                        # tie-breakeræ··åˆç³»æ•°
  diversity_weight: 0.35             # å¤šæ ·æ€§æƒé‡
  revise_gain_weight: 0.25           # æ”¹è¿›å¹…åº¦æƒé‡
  exec_success_weight: 0.20          # æ‰§è¡ŒæˆåŠŸåº¦æƒé‡
  efficiency_weight: 0.10            # æ•ˆç‡æƒé‡
  op_variety_weight: 0.10            # Operatorå¤šæ ·æ€§æƒé‡
  min_advantage_std: 0.10            # æœ€å°ä¼˜åŠ¿æ ‡å‡†å·®
  batch_calibration: true            # æ‰¹å†…æ ¡å‡†
