# AFlow + ROLL é›†æˆè®­ç»ƒé…ç½®
# ğŸ”¥ P13ä¿®å¤: K=2, B=5 é™ä½å¹¶å‘å‡å°‘è¶…æ—¶
# ä¿®æ”¹æ—¶é—´: 2024-11-30
# é…ç½®ç†å¿µ: é™ä½å¹¶å‘é¿å…vLLMæ’é˜Ÿè¶…æ—¶ï¼ŒLLMæå–åšä¸»åŠ›

# å®éªŒé…ç½®
exp_name: "aflow_grpo_k2_b5_p13fix"  # P13: K=2, B=5, LLMæå–ä¸»åŠ›
output_dir: "checkpoints"
log_dir: "logs"
max_steps: 500
save_every: 50
eval_every: 999999
val_samples: 87
log_every: 5

# =====================================
# GRPOç®—æ³•é…ç½®ï¼ˆåŸºäºæ™ºèƒ½ä½“åˆ†æä¼˜åŒ–ï¼‰
# =====================================
adv_estimator: "grpo"
num_return_sequences_in_group: 2   # ğŸ”¥ P13ä¿®å¤: K=2 å‡å°‘å¹¶å‘(åŸK=4å¯¼è‡´è¶…æ—¶55%)
ppo_epochs: 1
async_generation_ratio: 0
use_kl_loss: true
kl_loss_coef: 0.005                # ğŸ”¥ P1ä¿®å¤: ä»0.011é™åˆ°0.005ï¼Œå‡å°‘KLæƒ©ç½šå…è®¸æ›´å¤šæ¢ç´¢
clip_range: 0.20
gamma: 1.0
lambda_gae: 0.95

# =====================================
# Batché…ç½®
# =====================================
rollout_batch_size: 5              # ğŸ”¥ P13ä¿®å¤: B=5 å‡å°‘å¹¶å‘(åŸB=10), æ¯æ­¥10æ ·æœ¬
prompt_max_length: 3072
response_max_length: 5120

# æ¨¡å‹é…ç½®
base_model: "Qwen/Qwen2.5-7B-Instruct"  # HuggingFaceæ¨¡å‹åï¼ˆè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ï¼‰
model_dtype: "bfloat16"

# =====================================
# LoRAé…ç½®
# =====================================
use_lora: true
lora_rank: 64
lora_alpha: 64
lora_target_modules: "q_proj,k_proj,v_proj,o_proj"
lora_dropout: 0.05

# =====================================
# è®­ç»ƒå‚æ•°ï¼ˆåŸºäºæ™ºèƒ½ä½“åˆ†æä¼˜åŒ–ï¼‰
# =====================================
learning_rate: 2.0e-5              # ğŸ”¥ P1ä¿®å¤: æé«˜4å€å¢å¼ºå­¦ä¹ ä¿¡å·(åŸ5e-6å¤ªä½å¯¼è‡´KL=1e-8)
weight_decay: 0.01
max_grad_norm: 1.0                 # ğŸ”¥ P1ä¿®å¤: ä»0.5æå‡åˆ°1.0ï¼Œå…è®¸æ›´å¤§æ¢¯åº¦
gradient_accumulation_steps: 4     # ğŸ”§ OOMä¿®å¤: å¢åŠ åˆ°4ï¼Œå‡å°‘æ˜¾å­˜å³°å€¼
warmup_steps: 100                  # ğŸ”¥ P1ä¿®å¤: ä»50å¢åŠ åˆ°100ï¼ˆ20%è®­ç»ƒæ­¥æ•°ï¼‰
bf16: true
gradient_checkpointing: true       # ğŸ”§ OOMä¿®å¤: å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹

# GPUé…ç½®
device_mapping: [0]
physical_gpus: [0]  # A100 single GPU
protected_pids: []
num_gpus: 1
world_size: 1

# æ•°æ®é›†é…ç½®
data_dir: "data"
train_dataset: "data/ready_to_train/train_10k_final.jsonl"
val_dataset: "data/ready_to_train/test_500_preprocessed.jsonl"
test_dataset: "data/ready_to_train/test_500_preprocessed.jsonl"

# æ··åˆé‡‡æ ·æ¯”ä¾‹ (2:2:2 å‡åŒ€åˆ†å¸ƒ)
domain_ratios:
  math: 0.333
  code: 0.333
  qa: 0.334

# AFlowé…ç½®
aflow_config_path: "config/aflow_llm.yaml"
aflow_executor_model: "gpt-4o-mini"  # ä½¿ç”¨OpenAI API
aflow_operators: ["Custom", "AnswerGenerate", "Programmer", "ScEnsemble", "Test", "Review", "Revise"]
aflow_operator_descriptions_path: "config/operator.json"  # ä½¿ç”¨æœ¬åœ°è·¯å¾„
execution_timeout: 600

# =====================================
# å¥–åŠ±é…ç½®ï¼ˆä¿æŒåŸå€¼ï¼‰
# =====================================
reward_weights:
  correctness: 0.65
  efficiency: 0.15
  simplicity: 0.10
  format: 0.05
  repetition: 0.05

# æç¤ºè¯ä¼˜åŒ–ç³»ç»Ÿ
experience_buffer:
  enabled: true
  buffer_size: 100
  reward_threshold: 8.0
  persistence_dir: "data/experience_buffer"

prompt_optimizer:
  enabled: true
  few_shot_k: 3
  similarity_threshold: 0.7

operator_prompt_enhancer:
  enabled: true
  top_k_examples: 2

# ç›‘æ§é…ç½®
wandb:
  enabled: true
  project: "agent-prompt"
  entity: "yao110002-sdfsdfsdfsdf-com"
  api_key: "YOUR_WANDB_API_KEY"  # è¯·æ›¿æ¢ä¸ºä½ çš„wandb api key
  run_name: null

# =====================================
# Temperatureè°ƒåº¦ï¼ˆå¯ç”¨åŠ¨æ€æ¢ç´¢ï¼‰
# =====================================
temperature_schedule:
  enabled: true                    # ğŸ”¥ P1ä¿®å¤: å¯ç”¨æ¸©åº¦è°ƒåº¦
  initial: 0.5                     # ğŸ”¥ æ—©æœŸé«˜æ¸©å¢åŠ æ¢ç´¢
  final: 0.15                      # ğŸ”¥ åæœŸä½æ¸©åˆ©ç”¨æœ€ä¼˜ç­–ç•¥
  warmup_steps: 150                # ğŸ”¥ 30%æ­¥æ•°å†…å®Œæˆè¡°å‡

# =====================================
# ç”Ÿæˆé…ç½®
# =====================================
generation_config:
  temperature: 0.5                 # ğŸ”¥ åˆå§‹æ¸©åº¦ï¼ˆä¼šè¢«è°ƒåº¦è¦†ç›–ï¼‰
  top_p: 0.95
  top_k: 50
  max_new_tokens: 4096
  do_sample: true

# è°ƒè¯•é€‰é¡¹
debug: true
verbose: true

# =====================================
# WA-GRPOé…ç½®ï¼ˆWorkflow-Awareä¼˜åŠ¿è®¡ç®—ï¼‰
# =====================================
wa_grpo:
  alpha: 0.12                        # tie-breakeræ··åˆç³»æ•°
  diversity_weight: 0.35             # å¤šæ ·æ€§æƒé‡
  revise_gain_weight: 0.25           # æ”¹è¿›å¹…åº¦æƒé‡
  exec_success_weight: 0.20          # æ‰§è¡ŒæˆåŠŸåº¦æƒé‡
  efficiency_weight: 0.10            # æ•ˆç‡æƒé‡
  op_variety_weight: 0.10            # Operatorå¤šæ ·æ€§æƒé‡
  min_advantage_std: 0.10            # æœ€å°ä¼˜åŠ¿æ ‡å‡†å·®
  batch_calibration: true            # æ‰¹å†…æ ¡å‡†
